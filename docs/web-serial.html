<html>
  <head>
      <title>Web-serial API Terminal Example</title>
      <link href="resources/style.css" rel="stylesheet" type="text/css" />
      <link href="https://fonts.googleapis.com/css?family=Inconsolata&display=swap" rel="stylesheet">
      <script type="text/javascript" src="resources/uterm.js"></script>
      <style>
          #terminal {
              background: rgb(2,0,36);
              background: linear-gradient(90deg, rgba(2,0,36,1) 0%, rgba(9,9,121,1) 35%, rgba(0,212,255,1) 100%);
              font-size: 13px;
              font-family: 'Inconsolata', 'Andale Mono', 'Droid Sans Mono', 'Consolas', monospace;
              color: #ffc;
              width: 500px;
              height: 400px;
              line-height: 110%;
              border: none;
              padding: 2px;
              box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
          }
      </style>
  </head>

  <body>
      <h2>Web-serial API Terminal Example</h2>
      Any characters that are recieved by the browser from a 
      connected serial device will be displayed in the box below.  
      To send characters from the browser to the connected device, 
      simply click into the box below and begin typing.
      <div id="terminal"></div>
      <button id="connect-serial">Connect</button>
      <input id="baudrate_input" value="115200" />
      <script>
          let reader = {};
          let writer = {};
          var term = new uTerm(document.getElementById('terminal'), function(characterToSend) {
              writer.write(characterToSend);
          });

          document.getElementById('connect-serial').addEventListener('click', clickConnect);

          async function connect(baud) {
              // - Request a port and open a connection.
              port = await navigator.serial.requestPort();
              // - Wait for the port to open.
              await port.open({
                  baudrate: baud
              });

              const decoder = new TextDecoderStream();
              const inputDone = port.readable.pipeTo(decoder.writable);
              const inputStream = decoder.readable;

              reader = inputStream.getReader();

              const encoder = new TextEncoderStream();
              const outputDone = encoder.readable.pipeTo(port.writable);
              const outputStream = encoder.writable;

              writer = outputStream.getWriter();
          }

          async function clickConnect() {
              let baud = document.getElementById('baudrate_input').value || '115200';
              await connect(parseInt(baud));
              await readLoop();
          }

          async function readLoop() {
              while (true) {
                  const {
                      value, done
                  } = await reader.read();
                  if (value) {
                      term.display(value);
                  }
                  if (done) {
                      console.log('[readLoop] DONE', done);
                      reader.releaseLock();
                      break;
                  }
              }
          }
      </script>
  </body>
</html>
