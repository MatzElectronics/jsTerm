<html>
  <head>
    <title>uTerm Example</title>
    <link href="resources/style.css" rel="stylesheet" type="text/css" />
    <script type="text/javascript" src="resources/uterm.js"></script> 
    <script>
    
    </script>
    <style>
      #terminal {
          background: black;
          font-size: 13px;
          font-family: Andale Mono, Droid Sans Mono, Consolas, monospace;
          color: white;
          width: 420px;
          height: 360px;
          line-height: 110%;
          border: 2px solid black;
      }
    </style>
  </head>
  <body>
    <h2>uTerm Example</h2>
          <div id="terminal"></div>
          <button onclick="clickConnect();">Connect</button>
<input id="baudrate_input" value="115200" />

    <script>
       let reader = {};
let writer = {};
	var term = new uTerm(document.getElementById('terminal'), function(characterToSend) {
      	writer.write(characterToSend);
       });
      
      document.getElementById('send-string-btn').addEventListener('click', function () {
        var textInput = document.getElementById('send-string');
        term.display(textInput.value.replace(/\\r/g, '\r').replace(/\\n/g, '\n'));
        textInput.value = '';
      });
      
      document.getElementById('send-ascii').addEventListener('keyup', function () {
        var charInput = document.getElementById('send-ascii');
        charInput.value = charInput.value.replace(/[^0-9]*/g, '');
        if (charInput.value.length < 1) {
          charInput.value = '0';
        }
        if (parseInt(charInput.value) > 255) {
          charInput.value = '255'; 
        }
      });
      
      document.getElementById('send-ascii-btn').addEventListener('click', function () {
        var charInput = document.getElementById('send-ascii');
        term.display(String.fromCharCode(parseInt(charInput.value)));
      });
      
      


async function connect(baud) {
	// - Request a port and open a connection.
	port = await navigator.serial.requestPort();
	// - Wait for the port to open.
	await port.open({ baudrate: baud });

	const decoder = new TextDecoderStream();
	const inputDone = port.readable.pipeTo(decoder.writable);
	const inputStream = decoder.readable;

	reader = inputStream.getReader();

	const encoder = new TextEncoderStream();
	const outputDone = encoder.readable.pipeTo(port.writable);
	const outputStream = encoder.writable;

	writer = outputStream.getWriter();

}

async function clickConnect() {
	// Call to the button to .
	let baud = document.getElementById('baudrate_input').value || '115200';
	await connect(parseInt(baud));
	await readLoop();
}



// CODELAB: Add code to read the stream here.



async function readLoop() {

	// CODELAB: Add read loop here.
	while (true) {
	  const { value, done } = await reader.read();
	  if (value) {
	    term.display(value);
	  }
	  if (done) {
	    console.log('[readLoop] DONE', done);
	    reader.releaseLock();
	    break;
	  }
	}
}

    </script>
  <body>
</html>
